<html>
    <head>
        <title>Journal</title>
        <link rel="stylesheet" href="../bootstrap-3.3.7/dist/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="../database.json"></script>
    </head>

    <body id="journal_div" onload="show_journal()" style="width: auto;">
        
        <script>
                var acc_type_list="";
                //account subtypes
                var asset_subtype_list="";
                var data="";

            function create_journal(row, col, head, data){
                var journal="";
                var id=1;
                journal = "<table id='journal' class='table'>";

                journal += "<thead>";
                journal += "<tr>";
                for(i=0; i<col; i++){
                    journal+="<th>"+head[i]+"</th>";
                }//for head
                journal+="</tr>";
                journal+="</thead>";

                journal += "<tbody>";
                //accont types
                acc_type_list=Object.keys(data);

                //creating journal
                for(i=0; i<row; i++){
                    journal += "<tr>";
                    //account number
                    journal += "<td><input id="+id+" onkeypress='getAcc(event, this)' type='text'style='width:80px;'></td>";
                    id++;
                    //account type
                    journal += "<td><select id="+id+" onchange='getSubList(this)' style='width:180px;'><option disabled selected value> -- select an option -- </option>";
                    id++;
                    for(account_index=0; account_index<acc_type_list.length; account_index++){
                        journal+="<option value="+acc_type_list[account_index]+">"+acc_type_list[account_index]+"</option>";
                    }//account_type
                    "</select></td>";
                    //account subtype
                    journal += "<td><select id="+id+" onchange='getAccList(this)' style='width:180px'><option disabled selected value> -- select an option -- </option>";
                    id++;
                    journal += "<td><select id="+id+" onchange='getAccNum(this)' style='width:180px'><option disabled selected value> -- select an option -- </option>";
                    id++
                    for(k=0; k<2; k++){
                        journal += "<td><input id="+id+" type='text' style='width:80px'></td>";
                        id++;
                    }//for debit
                    journal += "</tr>";
                }//for row
                journal += "</tbody>";
                journal += "</table>";
                return journal;
            }//create_journal()

            function getAcc(event,input_acc) {
                if (event.keyCode == '13' && input_acc.value!='') {
                    val=input_acc.value;
                    x=findObjectByKeyJSON("id", val);
                }//if
                return;
            }//function

            function findObjectByKeyJSON(key, value){
                type_list=Object.keys(data);
                alert(type_list);
                for(i=0; i<type_list.length; i++){
                    sub_list=Object.keys(data[type_list[i]]);
                    for(j=0;j<sub_list.length;j++){
                        acc_list=data[type_list[i]][sub_list[j]];
                        for(k=0; k<acc_list; k++){
                            if(data[type_list[i]][sub_list[j]][k][key]==value)
                                return data[type_list[i]][sub_list[j]][k];
                        }//for
                    }//for
                }//for
            }//findObject

            function findObjectByKey(array, key, value) {
                    for (var i = 0; i < array.length; i++) {
                        if (array[i][key] === value) {
                            return array[i];
                        }
                    }
                    return null;
                }//find object from an array

            function getAccNum(select_acc){
                select_acc_id=select_acc.getAttribute("id");
                select_acc_value=select_acc.value;

                select_subtype_value=document.getElementById(parseInt(select_acc_id)-1).value;
                select_type_value=document.getElementById(parseInt(select_acc_id)-2).value;
                input_acc_num=document.getElementById(parseInt(select_acc_id)-3);

                list_acc=data[select_type_value][select_subtype_value];
                acc=findObjectByKey(list_acc, "title", select_acc_value);
                input_acc_num.value=acc["id"];
            }//getAccNum()

            function getAccList(select_subtype){
                select_subtype_id=select_subtype.getAttribute("id");
                select_subtype_value=select_subtype.value;
            
                select_type=document.getElementById(select_subtype_id-1);
                select_type_value=select_type.value;

                select_acc=document.getElementById(parseInt(select_subtype_id)+1);
                input_acc_num=document.getElementById(parseInt(select_type_id)-1);
                clearSelect(select_acc);

                list=data[select_type_value][select_subtype_value];
                //acc_num
                option=document.createElement("option");
                option.text=list[0]["title"];
                select_acc.add(option);
                input_acc_num.value=list[0]["id"];
                for(i=1;i<list.length;i++){
                    option=document.createElement("option");
                    option.text=list[i]["title"];
                    select_acc.add(option);
                }//for
            }//getAccList
            
            function getSubList(select_type){
                select_type_id=select_type.getAttribute("id");
                select_type_value=select_type.value;

                select_subtype=document.getElementById(parseInt(select_type_id)+1);
                clearSelect(select_subtype);
                list_type=Object.keys(data[select_type_value]);
                for(i=0;i<list_type.length;i++){
                    option=document.createElement("option");
                    option.text=list_type[i];
                    select_subtype.add(option);
                }//for
                select_subtype_value=select_subtype.value;

                select_acc=document.getElementById(parseInt(select_type_id)+2);
                input_acc_num=document.getElementById(parseInt(select_type_id)-1);
                clearSelect(select_acc);
                list_acc=data[select_type_value][select_subtype_value];
                //acc_num
                option=document.createElement("option");
                    option.text=list_acc[0]["title"];
                    select_acc.add(option);
                    input_acc_num.value=list_acc[0]["id"];
                for(i=1;i<list_acc.length;i++){
                    option=document.createElement("option");
                    option.text=list_acc[i]["title"];
                    select_acc.add(option);
                }//for
            }//getSubList

            function clearSelect(select){
                for (i = select.length - 1; i >= 0; i--) {
                    select.remove(i);
                }
            }//clearSelect

            function create_button(func, val){
                var button="";
                button="<button onclick="+func+" class='btn btn-primary'>"+val+"</button>";
                return button;
            }//create_button()

            function create_row(journal, col) {
                    //get the last input id
                    cells=document.getElementsByTagName("td");
                    id=cells[cells.length-1].childNodes[0].getAttribute("id");
                    //insert new row
                    row = journal.insertRow(-1);
                    html = "";
                    id++;
                    html= "<td><input id="+id+" type='text' style='width:80px;'></td>";
                    id++;
                    //account type
                    html += "<td><select id="+id+" onchange='getSubList(this)' style='width:180px'><option disabled selected value> -- select an option -- </option>";
                    id++;
                    for(account_index=0; account_index<acc_type_list.length; account_index++){
                        html+="<option value="+acc_type_list[account_index]+">"+acc_type_list[account_index]+"</option>";
                    }//account_type
                    "</select></td>";
                    //account subtype
                    html += "<td><select id="+id+" onchange='getAccList(this)' style='width:180px'><option disabled selected value> -- select an option -- </option>";
                    id++;
                    html += "<td><select id="+id+" onchange='getAccNum(this)' style='width:180px'><option disabled selected value> -- select an option -- </option>";
                    id++
                    for(k=0; k<2; k++){
                        html += "<td><input id="+id+" type='text' style='width:80px;'></td>";
                        id++;
                    }//for debit
                    row.innerHTML=html;
                }//create_row

            function show_journal(){
                $.getJSON("database.json", {},function(database) {
                    data=database;
                    head=["Number", "Type", "Sub-type", "GL Account", "Debit", "Credit"];
                    html="";
                    journal=create_journal(2, 6, head, data);
                    add_row_button=create_button("'create_row(document.getElementById(\"journal\"), 6)'", "More");
                    post_button=create_button("'post_entries(document.getElementById(\"journal\"))'", "Post");
                    html=journal+add_row_button+post_button;
                    document.getElementById("journal_div").innerHTML=html;
                });
            }//show_journal()
        </script>
    </body>
</html>